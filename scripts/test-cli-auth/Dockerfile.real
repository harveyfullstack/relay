# CLI OAuth Flow Test Container - Real CLIs
#
# This container installs the actual AI provider CLIs and tests
# URL extraction from their OAuth flows.
#
# Installation methods match deploy/workspace/Dockerfile to ensure consistency.
#
# Usage:
#   docker build -f Dockerfile.real -t cli-oauth-test-real scripts/test-cli-auth/
#   docker run --rm cli-oauth-test-real
#
# For interactive testing:
#   docker run --rm -it cli-oauth-test-real bash

# Build stage for relay-pty
# Note: Cargo.lock v4 requires Rust 1.78+
FROM rust:1.82-slim AS builder

WORKDIR /build
COPY relay-pty/ ./relay-pty/
RUN cd relay-pty && cargo build --release

# Runtime stage
FROM node:20-slim

# Install system dependencies (matches deploy/workspace/Dockerfile)
RUN apt-get update && apt-get install -y \
    bash \
    ca-certificates \
    curl \
    git \
    python3 \
    make \
    g++ \
    jq \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy relay-pty binary from builder
COPY --from=builder /build/relay-pty/target/release/relay-pty /app/bin/relay-pty
RUN chmod +x /app/bin/relay-pty

# Install npm-based CLIs globally as root (npm -g requires root)
RUN npm install -g @openai/codex || echo "Codex install failed"
RUN npm install -g @google/gemini-cli || echo "Gemini install failed"
RUN npm install -g opencode-ai@latest || echo "OpenCode install failed"
RUN npm install -g typescript

# Create test user (CLIs install to ~/.local/bin)
RUN useradd -m -u 1001 testuser
RUN chown -R testuser:testuser /app
USER testuser

# Install AI CLIs as testuser (these install scripts write to ~/.local/bin)

# Claude - uses official install script
RUN curl -fsSL https://claude.ai/install.sh | bash || echo "Claude install failed"
# Note: We don't pre-seed Claude config - we want to test the full interactive flow
# including the dark mode and auth method prompts

# Note: OpenCode is installed as root above via npm

# Droid - uses official install script
RUN curl -fsSL https://app.factory.ai/cli | sh || echo "Droid install failed"

# Add user's local bin and relay-pty to PATH
ENV PATH="/app/bin:/home/testuser/.local/bin:$PATH"

# Copy test files and source dependencies
# Context is repo root, so paths are relative to that
# Maintain the same directory structure as the source repo so relative imports work
COPY --chown=testuser:testuser scripts/test-cli-auth/ci-test-real-clis.ts /app/scripts/test-cli-auth/
COPY --chown=testuser:testuser scripts/test-cli-auth/package.json /app/scripts/test-cli-auth/

# Copy source modules from packages (after package extraction)
# cli-pty-runner.ts imports from '@agent-relay/config/cli-auth-config'
COPY --chown=testuser:testuser packages/cloud/src/api/cli-pty-runner.ts /app/packages/cloud/src/api/

# Set up @agent-relay/config package for the import to work
# Copy package.json and source, then build to dist/
COPY --chown=testuser:testuser packages/config/package.json /app/node_modules/@agent-relay/config/
COPY --chown=testuser:testuser packages/config/src/ /app/node_modules/@agent-relay/config/src/
COPY --chown=testuser:testuser packages/config/tsconfig.json /app/node_modules/@agent-relay/config/

# Also need @agent-relay/protocol since config depends on it
COPY --chown=testuser:testuser packages/protocol/package.json /app/node_modules/@agent-relay/protocol/
COPY --chown=testuser:testuser packages/protocol/src/ /app/node_modules/@agent-relay/protocol/src/
COPY --chown=testuser:testuser packages/protocol/tsconfig.json /app/node_modules/@agent-relay/protocol/

# Build protocol first (config depends on it)
# Protocol has no runtime dependencies, just needs TypeScript to compile
RUN cd /app/node_modules/@agent-relay/protocol && tsc

# Build config package
# Config needs zod (runtime dep) but @agent-relay/protocol is already in node_modules
# Install only external dependencies, not internal @agent-relay/* packages
RUN cd /app/node_modules/@agent-relay/config && \
    npm install --ignore-scripts zod zod-to-json-schema && \
    tsc

# Install test dependencies (from scripts/test-cli-auth directory)
RUN cd /app/scripts/test-cli-auth && npm install

# Verify relay-pty is available
RUN echo "=== Checking relay-pty ===" && \
    which relay-pty && relay-pty --version || echo "relay-pty: not found"

# Verify which CLIs are installed
RUN echo "=== Installed CLIs ===" && \
    (which claude && claude --version 2>&1 | head -1) || echo "claude: not found" && \
    (which codex && codex --version 2>&1 | head -1) || echo "codex: not found" && \
    (which gemini && gemini --version 2>&1 | head -1) || echo "gemini: not found" && \
    (which opencode && opencode --version 2>&1 | head -1) || echo "opencode: not found" && \
    (which droid && droid --version 2>&1 | head -1) || echo "droid: not found"

# Set working directory to where the test script is (so npm/npx can find local node_modules)
WORKDIR /app/scripts/test-cli-auth

# Default command runs the CI tests
CMD ["npx", "tsx", "ci-test-real-clis.ts"]
