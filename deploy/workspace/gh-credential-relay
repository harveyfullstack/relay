#!/usr/bin/env bash
#
# GitHub CLI Credential Helper for Agent Relay Workspaces
#
# This credential helper provides GitHub authentication tokens to the gh CLI
# by fetching from the cloud API. It works in non-interactive container
# environments without requiring manual gh auth login.
#
# Installation:
#   gh config set -h github.com credential-helper gh-credential-relay
#
# Environment variables (auto-set by workspace entrypoint):
#   CLOUD_API_URL    - Cloud API base URL
#   WORKSPACE_ID     - Workspace identifier
#   WORKSPACE_TOKEN  - Bearer token for cloud API auth

set -euo pipefail

# Debug logging (enable with GH_CREDENTIAL_DEBUG=1)
debug() {
  if [[ "${GH_CREDENTIAL_DEBUG:-}" == "1" ]]; then
    echo "gh-credential-relay: $*" >&2
  fi
}

debug "Called with args: $*"

# Only handle 'get' operation for storing credentials
if [[ "${1:-}" != "get" ]]; then
  debug "Ignoring non-get operation: ${1:-}"
  exit 0
fi

# Read input from gh CLI (host, protocol, etc)
declare -A input
while IFS='=' read -r key value; do
  [[ -z "$key" ]] && break
  input["$key"]="$value"
done

host="${input[host]:-}"
debug "Host: $host"

# Only provide credentials for github.com
if [[ "$host" != "github.com" ]]; then
  debug "Not github.com, skipping"
  exit 0
fi

# Check required environment variables
if [[ -z "${CLOUD_API_URL:-}" ]]; then
  echo "gh-credential-relay: CLOUD_API_URL not set" >&2
  exit 1
fi

if [[ -z "${WORKSPACE_ID:-}" ]]; then
  echo "gh-credential-relay: WORKSPACE_ID not set" >&2
  exit 1
fi

if [[ -z "${WORKSPACE_TOKEN:-}" ]]; then
  echo "gh-credential-relay: WORKSPACE_TOKEN not set" >&2
  exit 1
fi

debug "Fetching token from ${CLOUD_API_URL}/api/git/token?workspaceId=${WORKSPACE_ID}"

# Fetch fresh token from cloud API (5 second timeout)
response=$(curl -s --max-time 5 \
  -H "Authorization: Bearer ${WORKSPACE_TOKEN}" \
  "${CLOUD_API_URL}/api/git/token?workspaceId=${WORKSPACE_ID}" 2>/dev/null) || true

if [[ -z "$response" ]]; then
  debug "No response from cloud API"
  exit 1
fi

# Parse JSON response
token=$(echo "$response" | jq -r '.userToken // .token // empty' 2>/dev/null)

if [[ -z "$token" ]]; then
  debug "No token in response"
  exit 1
fi

# Output in git credential format (same as git-credential-relay)
echo "protocol=https"
echo "host=github.com"
echo "username=x-access-token"
echo "password=${token}"
