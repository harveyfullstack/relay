name: Force Update Workspaces

on:
  workflow_dispatch:

jobs:
  update-workspaces:
    name: Force Update Workspaces
    runs-on: ubuntu-latest

    steps:
      - name: Update workspace images
        env:
          CLOUD_API_URL: ${{ secrets.CLOUD_API_URL }}
          ADMIN_API_SECRET: ${{ secrets.ADMIN_API_SECRET }}
        run: |
          if [ -z "$CLOUD_API_URL" ] || [ -z "$ADMIN_API_SECRET" ]; then
            echo "‚ùå CLOUD_API_URL or ADMIN_API_SECRET not configured"
            exit 1
          fi

          echo "üîÑ Force updating workspaces to ghcr.io/agentworkforce/relay-workspace:latest"

          # Remove trailing slash from CLOUD_API_URL if present
          API_URL="${CLOUD_API_URL%/}"

          response=$(curl -s -w "\n%{http_code}" -X POST "${API_URL}/api/admin/workspaces/update-image" \
            -H "x-admin-secret: ${ADMIN_API_SECRET}" \
            -H "Content-Type: application/json" \
            -d '{"image": "ghcr.io/agentworkforce/relay-workspace:latest", "force": true, "skipRestart": false}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "‚úÖ Workspace update initiated successfully"
            echo "$body" | jq . 2>/dev/null || echo "$body"
          else
            echo "‚ùå Failed to update workspaces (HTTP $http_code)"
            echo "$body"
            exit 1
          fi
