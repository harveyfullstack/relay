name: Verify Published Package

# This workflow verifies that the published npm package works correctly
# across multiple Node.js versions using both global install and npx.
#
# Triggered:
# - Automatically after publish workflow completes
# - Manually via workflow_dispatch
# - On PR (for testing the workflow itself)

on:
  pull_request:
    paths:
      - ".github/workflows/verify-publish.yml"
      - "scripts/post-publish-verify/**"
  workflow_dispatch:
    inputs:
      version:
        description: "Package version to verify (default: latest)"
        required: false
        type: string
        default: "latest"
  workflow_call:
    inputs:
      version:
        description: "Package version to verify"
        required: false
        type: string
        default: "latest"

jobs:
  verify:
    name: Verify Node ${{ matrix.node }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ["18", "20", "22"]

    steps:
      - name: Checkout (for scripts)
        uses: actions/checkout@v4

      - name: Install deps for pack (PR only)
        if: github.event_name == 'pull_request'
        run: npm ci

      - name: Build packages (PR only)
        if: github.event_name == 'pull_request'
        run: npm run build

      - name: Pack local tarball (PR only)
        if: github.event_name == 'pull_request'
        run: npm pack

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Get package spec
        id: pkg
        run: |
          VERSION_INPUT="${{ inputs.version }}"
          if [ -z "$VERSION_INPUT" ] || [ "$VERSION_INPUT" = "latest" ]; then
            VERSION="latest"
            SPEC="agent-relay"
          else
            VERSION="$VERSION_INPUT"
            SPEC="agent-relay@${VERSION}"
          fi
          echo "spec=$SPEC" >> $GITHUB_OUTPUT
          echo "Testing: $SPEC"

      # Wait for npm to propagate the package
      - name: Wait for npm propagation
        if: inputs.version != 'latest'
        run: |
          echo "Waiting for npm to propagate version ${{ inputs.version }}..."
          FOUND=0
          for i in {1..30}; do
            if npm view agent-relay@${{ inputs.version }} version 2>/dev/null; then
              echo "Package found on npm registry"
              FOUND=1
              break
            fi
            echo "Attempt $i: Package not yet available, waiting 10s..."
            sleep 10
          done
          if [ "$FOUND" -eq 0 ]; then
            echo "ERROR: Package agent-relay@${{ inputs.version }} not found on npm after 5 minutes"
            exit 1
          fi

      # Test 1: Global npm install
      - name: "Test: Global npm install"
        run: |
          echo "Installing ${{ steps.pkg.outputs.spec }} globally..."
          npm install -g ${{ steps.pkg.outputs.spec }}
          # Add npm global bin to PATH
          echo "$(npm config get prefix)/bin" >> $GITHUB_PATH

      - name: "Test: Global --version"
        run: |
          # Ensure npm global bin is in PATH
          export PATH="$(npm config get prefix)/bin:$PATH"
          VERSION=$(agent-relay --version)
          echo "Version output: $VERSION"
          if echo "$VERSION" | grep -qE '[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "Version check passed"
          else
            echo "Version check failed - no version number found"
            exit 1
          fi

      - name: "Test: Global -V flag"
        run: |
          export PATH="$(npm config get prefix)/bin:$PATH"
          agent-relay -V

      - name: "Test: Global version command"
        run: |
          export PATH="$(npm config get prefix)/bin:$PATH"
          OUTPUT=$(agent-relay version)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -qE '[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "Version command check passed"
          else
            exit 1
          fi

      - name: "Test: Global --help"
        run: |
          export PATH="$(npm config get prefix)/bin:$PATH"
          agent-relay --help | head -20

      - name: Cleanup global install
        run: |
          export PATH="$(npm config get prefix)/bin:$PATH"
          npm uninstall -g agent-relay

      # Test 2: npx execution
      # Note: Don't use `--` separator with npx @version syntax - it causes argument parsing issues
      - name: "Test: npx --version"
        run: |
          echo "npx package spec: ${{ steps.pkg.outputs.spec }}"
          if [ -z "${{ steps.pkg.outputs.spec }}" ]; then
            echo "Package spec is empty - failing fast"
            exit 1
          fi
          # npx with @ syntax - downloads and runs in one command
          VERSION=$(npx ${{ steps.pkg.outputs.spec }} --version 2>&1)
          echo "npx version output: $VERSION"
          if echo "$VERSION" | grep -qE '[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "npx version check passed"
          else
            exit 1
          fi

      - name: "Test: npx --help"
        run: npx ${{ steps.pkg.outputs.spec }} --help | head -20

      - name: "Test: npx version command"
        run: |
          OUTPUT=$(npx ${{ steps.pkg.outputs.spec }} version 2>&1)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -qE '[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "npx version command check passed"
          else
            exit 1
          fi

      # Test 3: Local project install
      - name: "Test: Local project install"
        run: |
          mkdir -p /tmp/test-project
          cd /tmp/test-project
          npm init -y
          npm install ${{ steps.pkg.outputs.spec }}

      - name: "Test: Local npx execution"
        run: |
          cd /tmp/test-project
          VERSION=$(npx agent-relay --version)
          echo "Local npx version: $VERSION"
          if echo "$VERSION" | grep -qE '[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "Local npx check passed"
          else
            exit 1
          fi

      - name: "Test: Local bin executable"
        run: |
          cd /tmp/test-project
          if [ -x "./node_modules/.bin/agent-relay" ]; then
            VERSION=$(./node_modules/.bin/agent-relay --version)
            echo "Local bin version: $VERSION"
          else
            echo "Local bin not found or not executable"
            exit 1
          fi

      # Test 4: relay-pty binary verification (critical for spawn)
      - name: "Test: relay-pty binary exists"
        run: |
          cd /tmp/test-project
          BIN_DIR="./node_modules/agent-relay/bin"
          echo "Checking for relay-pty binaries..."
          ls -la "$BIN_DIR" || { echo "Binary directory not found"; exit 1; }

          if [ -f "$BIN_DIR/relay-pty" ]; then
            echo "relay-pty binary found"
          else
            echo "relay-pty binary NOT found - spawn will fail!"
            exit 1
          fi

      - name: "Test: relay-pty binary executable"
        run: |
          cd /tmp/test-project
          BIN_DIR="./node_modules/agent-relay/bin"

          if [ -x "$BIN_DIR/relay-pty" ]; then
            echo "relay-pty is executable"
          else
            echo "relay-pty is NOT executable"
            exit 1
          fi

      - name: "Test: relay-pty --help works"
        run: |
          cd /tmp/test-project
          BIN_DIR="./node_modules/agent-relay/bin"

          OUTPUT=$("$BIN_DIR/relay-pty" --help 2>&1) || true
          echo "$OUTPUT"

          if echo "$OUTPUT" | grep -q "PTY wrapper"; then
            echo "relay-pty --help check passed"
          else
            echo "relay-pty --help failed or unexpected output"
            exit 1
          fi

      - name: "Test: Platform-specific binary"
        run: |
          cd /tmp/test-project
          BIN_DIR="./node_modules/agent-relay/bin"

          # Determine platform
          PLATFORM=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)

          case "$ARCH" in
            x86_64) ARCH_NAME="x64" ;;
            aarch64|arm64) ARCH_NAME="arm64" ;;
            *) ARCH_NAME="$ARCH" ;;
          esac

          echo "Platform: $PLATFORM, Architecture: $ARCH_NAME"
          PLATFORM_BINARY="relay-pty-${PLATFORM}-${ARCH_NAME}"

          if [ -f "$BIN_DIR/$PLATFORM_BINARY" ]; then
            echo "Platform-specific binary found: $PLATFORM_BINARY"
            if [ -x "$BIN_DIR/$PLATFORM_BINARY" ]; then
              echo "Platform-specific binary is executable"
            else
              echo "WARNING: Platform-specific binary is not executable"
            fi
          else
            echo "Platform-specific binary not found: $PLATFORM_BINARY"
            echo "Will rely on generic relay-pty binary"
          fi

      - name: "Test: Binary resolution simulation"
        run: |
          cd /tmp/test-project
          node -e "
          const path = require('path');
          const fs = require('fs');

          const packageDir = path.dirname(require.resolve('agent-relay/package.json'));
          const binDir = path.join(packageDir, 'bin');

          const platform = process.platform;
          const arch = process.arch;

          const platformMap = { darwin: 'darwin', linux: 'linux', win32: 'windows' };
          const archMap = { x64: 'x64', arm64: 'arm64' };

          const platformName = platformMap[platform] || platform;
          const archName = archMap[arch] || arch;

          const specificBinary = path.join(binDir, 'relay-pty-' + platformName + '-' + archName);
          const genericBinary = path.join(binDir, 'relay-pty');

          console.log('Package dir:', packageDir);
          console.log('Platform binary:', specificBinary, fs.existsSync(specificBinary) ? '✓' : '✗');
          console.log('Generic binary:', genericBinary, fs.existsSync(genericBinary) ? '✓' : '✗');

          if (!fs.existsSync(specificBinary) && !fs.existsSync(genericBinary)) {
            console.error('ERROR: No relay-pty binary found!');
            process.exit(1);
          }

          console.log('Binary resolution check passed');
          "

      - name: Cleanup
        run: rm -rf /tmp/test-project

  # macOS verification (tests darwin binaries)
  verify-macos:
    name: Verify macOS (${{ matrix.arch }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            arch: arm64
          - os: macos-12  # Intel runner (macos-13 retired, macos-12 deprecated but available)
            arch: x64
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout (for scripts)
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps for pack (PR only)
        if: github.event_name == 'pull_request'
        run: npm ci

      - name: Build packages (PR only)
        if: github.event_name == 'pull_request'
        run: npm run build

      - name: Pack local tarball (PR only)
        if: github.event_name == 'pull_request'
        run: npm pack

      - name: Get package spec
        id: pkg
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Use absolute path so it works when cd'ing to /tmp/test-project
            SPEC="$(pwd)/$(ls agent-relay-*.tgz | head -1)"
          else
            VERSION="${{ inputs.version || 'latest' }}"
            if [ "$VERSION" = "latest" ]; then
              SPEC="agent-relay"
            else
              SPEC="agent-relay@${VERSION}"
            fi
          fi
          echo "spec=$SPEC" >> $GITHUB_OUTPUT
          echo "Testing: $SPEC"

      # Wait for npm to propagate the package (same as verify job)
      - name: Wait for npm propagation
        if: inputs.version != 'latest'
        run: |
          echo "Waiting for npm to propagate version ${{ inputs.version }}..."
          FOUND=0
          for i in {1..30}; do
            if npm view agent-relay@${{ inputs.version }} version 2>/dev/null; then
              echo "Package found on npm registry"
              FOUND=1
              break
            fi
            echo "Attempt $i: Package not yet available, waiting 10s..."
            sleep 10
          done
          if [ "$FOUND" -eq 0 ]; then
            echo "ERROR: Package agent-relay@${{ inputs.version }} not found on npm after 5 minutes"
            exit 1
          fi

      - name: "Test: npm install"
        run: |
          mkdir -p /tmp/test-project
          cd /tmp/test-project
          npm init -y
          npm install ${{ steps.pkg.outputs.spec }}

      - name: "Test: CLI version"
        run: |
          cd /tmp/test-project
          VERSION=$(npx agent-relay --version)
          echo "Version: $VERSION"
          if echo "$VERSION" | grep -qE '[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "Version check passed"
          else
            exit 1
          fi

      - name: "Test: relay-pty binary exists"
        run: |
          cd /tmp/test-project
          BIN_DIR="./node_modules/agent-relay/bin"
          echo "Checking for relay-pty binaries..."
          ls -la "$BIN_DIR"

          if [ -f "$BIN_DIR/relay-pty" ]; then
            echo "relay-pty binary found"
          else
            echo "relay-pty binary NOT found!"
            exit 1
          fi

      - name: "Test: relay-pty is executable"
        run: |
          cd /tmp/test-project
          BIN_DIR="./node_modules/agent-relay/bin"

          if [ -x "$BIN_DIR/relay-pty" ]; then
            echo "relay-pty is executable"
          else
            echo "relay-pty is NOT executable"
            exit 1
          fi

      - name: "Test: relay-pty --help"
        run: |
          cd /tmp/test-project
          BIN_DIR="./node_modules/agent-relay/bin"

          OUTPUT=$("$BIN_DIR/relay-pty" --help 2>&1) || true
          echo "$OUTPUT"

          if echo "$OUTPUT" | grep -q "PTY wrapper"; then
            echo "relay-pty --help check passed"
          else
            echo "relay-pty --help failed"
            exit 1
          fi

      - name: "Test: Darwin-specific binary"
        run: |
          cd /tmp/test-project
          BIN_DIR="./node_modules/agent-relay/bin"

          ARCH="${{ matrix.arch }}"
          DARWIN_BINARY="relay-pty-darwin-${ARCH}"

          echo "Looking for: $DARWIN_BINARY"

          if [ -f "$BIN_DIR/$DARWIN_BINARY" ]; then
            echo "Darwin binary found: $DARWIN_BINARY"
            ls -la "$BIN_DIR/$DARWIN_BINARY"

            if [ -x "$BIN_DIR/$DARWIN_BINARY" ]; then
              echo "Darwin binary is executable"

              # Test it works
              OUTPUT=$("$BIN_DIR/$DARWIN_BINARY" --help 2>&1) || true
              if echo "$OUTPUT" | grep -q "PTY wrapper"; then
                echo "Darwin binary --help works"
              else
                echo "WARNING: Darwin binary --help unexpected output"
                echo "$OUTPUT"
              fi
            else
              echo "Darwin binary is NOT executable"
              exit 1
            fi
          else
            echo "Darwin binary not found, checking if generic works..."
            # The generic binary should work
            if "$BIN_DIR/relay-pty" --help 2>&1 | grep -q "PTY wrapper"; then
              echo "Generic binary works on macOS"
            else
              echo "Neither darwin-specific nor generic binary works!"
              exit 1
            fi
          fi

      - name: Cleanup
        run: rm -rf /tmp/test-project

  # Docker-based verification (more isolated)
  verify-docker:
    name: Verify Docker (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: ["18", "20", "22"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (for npm view)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Wait for npm to propagate the package (same as other verify jobs)
      - name: Wait for npm propagation
        if: inputs.version != 'latest'
        run: |
          echo "Waiting for npm to propagate version ${{ inputs.version }}..."
          FOUND=0
          for i in {1..30}; do
            if npm view agent-relay@${{ inputs.version }} version 2>/dev/null; then
              echo "Package found on npm registry"
              FOUND=1
              break
            fi
            echo "Attempt $i: Package not yet available, waiting 10s..."
            sleep 10
          done
          if [ "$FOUND" -eq 0 ]; then
            echo "ERROR: Package agent-relay@${{ inputs.version }} not found on npm after 5 minutes"
            exit 1
          fi

      - name: Build verification image
        run: |
          VERSION="${{ inputs.version || 'latest' }}"
          docker build \
            --build-arg NODE_VERSION=${{ matrix.node }} \
            --build-arg PACKAGE_VERSION=$VERSION \
            -t agent-relay-verify:node${{ matrix.node }} \
            -f scripts/post-publish-verify/Dockerfile \
            scripts/post-publish-verify/

      - name: Run verification
        run: |
          docker run --rm agent-relay-verify:node${{ matrix.node }}

  summary:
    name: Verification Summary
    needs: [verify, verify-macos, verify-docker]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## Post-Publish Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package**: \`agent-relay@${{ inputs.version || 'latest' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Native Tests" >> $GITHUB_STEP_SUMMARY
          echo "| Node Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node 18 | ${{ needs.verify.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node 20 | ${{ needs.verify.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node 22 | ${{ needs.verify.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### macOS Tests (relay-pty binary)" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| arm64 (M1/M2) | ${{ needs.verify-macos.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| x64 (Intel) | ${{ needs.verify-macos.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Tests (Linux)" >> $GITHUB_STEP_SUMMARY
          echo "| Node Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node 18 | ${{ needs.verify-docker.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node 20 | ${{ needs.verify-docker.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node 22 | ${{ needs.verify-docker.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overall" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.verify.result }}" = "success" ] && [ "${{ needs.verify-macos.result }}" = "success" ] && [ "${{ needs.verify-docker.result }}" = "success" ]; then
            echo "✅ All verification tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some verification tests failed" >> $GITHUB_STEP_SUMMARY
          fi
