name: Stress Tests

on:
  push:
    branches: [main]
    paths:
      - 'relay-pty/src/**'
      - 'packages/daemon/src/orchestrator.ts'
      - 'packages/daemon/src/relay-*.ts'
      - 'scripts/stress-test-*.sh'
      - 'scripts/stress-test-*.mjs'
      - 'scripts/stress-test-*.mts'
      - '.github/workflows/stress-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'relay-pty/src/**'
      - 'packages/daemon/src/orchestrator.ts'
      - 'packages/daemon/src/relay-*.ts'
      - 'scripts/stress-test-*.sh'
      - 'scripts/stress-test-*.mjs'
      - 'scripts/stress-test-*.mts'
      - '.github/workflows/stress-tests.yml'
  # Allow manual trigger for on-demand stress testing
  workflow_dispatch:
  # Run weekly to catch performance regressions
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC

jobs:
  stress-test-relay-pty:
    name: Relay-PTY Stress Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [20]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run relay-pty stress tests
        id: relay-pty-stress
        run: |
          chmod +x scripts/stress-test-relay-pty.sh
          ./scripts/stress-test-relay-pty.sh > relay-pty-results.json 2>&1 || echo "exit_code=$?" >> $GITHUB_OUTPUT
          cat relay-pty-results.json
        continue-on-error: true

      - name: Upload relay-pty results
        uses: actions/upload-artifact@v4
        with:
          name: relay-pty-stress-results-${{ matrix.os }}-node${{ matrix.node-version }}
          path: relay-pty-results.json
          retention-days: 30

      - name: Check relay-pty results
        run: |
          if ! node -e "
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('relay-pty-results.json', 'utf8'));
            const allPassed = Object.values(results).every(r => r.passed);
            console.log('All tests passed:', allPassed);
            process.exit(allPassed ? 0 : 1);
          "; then
            echo "::error::Relay-PTY stress tests failed"
            exit 1
          fi

  stress-test-orchestrator:
    name: Orchestrator Stress Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [20]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run orchestrator stress tests
        id: orchestrator-stress
        run: |
          node scripts/stress-test-orchestrator.mjs --json > orchestrator-results.json 2>&1 || echo "exit_code=$?" >> $GITHUB_OUTPUT
          cat orchestrator-results.json
        continue-on-error: true

      - name: Upload orchestrator results
        uses: actions/upload-artifact@v4
        with:
          name: orchestrator-stress-results-${{ matrix.os }}-node${{ matrix.node-version }}
          path: orchestrator-results.json
          retention-days: 30

      - name: Check orchestrator results
        run: |
          if ! node -e "
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('orchestrator-results.json', 'utf8'));
            console.log('All tests passed:', results.passed);
            console.log('Failures:', results.failures);
            process.exit(results.passed ? 0 : 1);
          "; then
            echo "::error::Orchestrator stress tests failed"
            exit 1
          fi

  stress-test-orchestrator-integration:
    name: Orchestrator Integration Stress Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [20]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Run orchestrator integration stress tests
        id: integration-stress
        run: |
          npx tsx scripts/stress-test-orchestrator-integration.mts --json > integration-results.json 2>&1 || echo "exit_code=$?" >> $GITHUB_OUTPUT
          cat integration-results.json
        continue-on-error: true

      - name: Upload integration results
        uses: actions/upload-artifact@v4
        with:
          name: orchestrator-integration-results-${{ matrix.os }}-node${{ matrix.node-version }}
          path: integration-results.json
          retention-days: 30

      - name: Check integration results
        run: |
          if ! node -e "
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('integration-results.json', 'utf8'));
            console.log('All tests passed:', results.passed);
            console.log('Passed:', results.summary.passed_tests, '/', results.summary.total_tests);
            process.exit(results.passed ? 0 : 1);
          "; then
            echo "::error::Orchestrator integration stress tests failed"
            exit 1
          fi

  stress-test-summary:
    name: Stress Test Summary
    needs: [stress-test-relay-pty, stress-test-orchestrator, stress-test-orchestrator-integration]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: stress-results

      - name: Generate summary
        run: |
          echo "## Stress Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Relay-PTY Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in stress-results/relay-pty-*/relay-pty-results.json; do
            if [ -f "$file" ]; then
              dirname=$(dirname "$file" | xargs basename)
              echo "#### $dirname" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              cat "$file" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "### Orchestrator Mock Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in stress-results/orchestrator-stress-*/orchestrator-results.json; do
            if [ -f "$file" ]; then
              dirname=$(dirname "$file" | xargs basename)
              echo "#### $dirname" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              cat "$file" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "### Orchestrator Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in stress-results/orchestrator-integration-*/integration-results.json; do
            if [ -f "$file" ]; then
              dirname=$(dirname "$file" | xargs basename)
              echo "#### $dirname" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              cat "$file" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check overall status
        if: needs.stress-test-relay-pty.result == 'failure' || needs.stress-test-orchestrator.result == 'failure' || needs.stress-test-orchestrator-integration.result == 'failure'
        run: |
          echo "::error::One or more stress tests failed"
          exit 1
