---
title: "Worker Spawning"
description: "Spawn and manage worker agents programmatically from your lead agent"
---

# Worker Spawning

Lead agents can spawn and release worker agents dynamically. Workers run as separate processes with their own PTY, enabling parallel task execution with full terminal capabilities.

## Quick Start

Spawn a worker agent using the file-based protocol:

```bash
cat > /tmp/relay-outbox/$AGENT_RELAY_NAME/spawn << 'EOF'
KIND: spawn
NAME: Worker1
CLI: claude

Implement the user authentication module using JWT tokens.
EOF
```

Then output: `->relay-file:spawn`

<Note>
The filename is always `spawn` (not `spawn-agentname`). Spawn one agent at a time and wait for confirmation before spawning the next.
</Note>

## Spawn Protocol

### Message Format

```
KIND: spawn
NAME: AgentName
CLI: cli-tool

Task description for the worker.
```

### Required Headers

| Header | Description |
|--------|-------------|
| `KIND` | Must be `spawn` |
| `NAME` | Unique name for the worker (PascalCase recommended) |
| `CLI` | CLI tool to use: `claude`, `codex`, `gemini`, `cursor` |

### Task Description

Everything after the blank line becomes the initial task message sent to the worker.

## Supported CLI Tools

| CLI | Command | Notes |
|-----|---------|-------|
| `claude` | Claude CLI | Adds `--dangerously-skip-permissions` automatically |
| `codex` | OpenAI Codex | Adds `--dangerously-bypass-approvals-and-sandbox` |
| `gemini` | Google Gemini | Adds `--yolo` for auto-accept |
| `cursor` | Cursor Agent | Maps to `agent` command, adds `--force` |

## Spawning Examples

### Basic Worker

```bash
cat > /tmp/relay-outbox/$AGENT_RELAY_NAME/spawn << 'EOF'
KIND: spawn
NAME: FrontendDev
CLI: claude

Build the login page component with:
- Email and password fields
- Remember me checkbox
- Forgot password link
- Form validation
EOF
```

Then: `->relay-file:spawn`

### Specialized Worker

```bash
cat > /tmp/relay-outbox/$AGENT_RELAY_NAME/spawn << 'EOF'
KIND: spawn
NAME: CodeReviewer
CLI: claude

Review all TypeScript files in src/ for:
- Type safety issues
- Error handling gaps
- Performance concerns
Report findings with file paths and line numbers.
EOF
```

Then: `->relay-file:spawn`

## Releasing Workers

When a worker completes its task, release it to free resources:

```bash
cat > /tmp/relay-outbox/$AGENT_RELAY_NAME/release << 'EOF'
KIND: release
NAME: Worker1
EOF
```

Then: `->relay-file:release`

### Release All Workers

Release all spawned workers at once:

```bash
cat > /tmp/relay-outbox/$AGENT_RELAY_NAME/release-all << 'EOF'
KIND: release
NAME: *
EOF
```

Then: `->relay-file:release-all`

## Role-Based Agents

Define agent profiles in `.claude/agents/` for consistent configurations:

**`.claude/agents/reviewer.md`**
```markdown
---
model: sonnet
role: reviewer
---

You are a code reviewer focused on:
- Code quality and best practices
- Security vulnerabilities
- Performance optimizations
```

When spawning, use the agent profile name:

```bash
cat > /tmp/relay-outbox/$AGENT_RELAY_NAME/spawn << 'EOF'
KIND: spawn
NAME: Reviewer
CLI: claude

Review the authentication module for security issues.
EOF
```

The spawner automatically loads the matching profile and applies:
- Model selection (`--model sonnet`)
- Agent configuration (`--agent reviewer`)
- Role-specific system prompts

### Agent Profile Format

**`.claude/agents/<name>.md`**
```yaml
---
model: opus | sonnet | haiku
role: planner | worker | reviewer | lead | shadow
---

Agent-specific instructions and context.
```

## Teams Configuration

Define your agent team in `teams.json` for auto-spawning:

**`.relay/teams.json`**
```json
{
  "team": "development",
  "autoSpawn": true,
  "agents": [
    {
      "name": "FrontendDev",
      "cli": "claude",
      "task": "Handle all frontend React components"
    },
    {
      "name": "BackendDev",
      "cli": "claude",
      "task": "Handle API endpoints and database"
    },
    {
      "name": "Reviewer",
      "cli": "claude",
      "task": "Review code changes before merge"
    }
  ]
}
```

Start with auto-spawn:

```bash
agent-relay up --spawn
```

Or trigger spawn manually:

```bash
agent-relay up
# Then spawn explicitly:
agent-relay up --spawn
```

## Worker Lifecycle

<Steps>
  <Step title="Spawn Request">
    Lead agent writes spawn file and outputs trigger.
  </Step>
  <Step title="Process Creation">
    Relay creates PTY process with CLI and relay instructions.
  </Step>
  <Step title="Registration">
    Worker sends HELLO to daemon and registers (up to 30s).
  </Step>
  <Step title="Task Delivery">
    Initial task message is sent after registration completes.
  </Step>
  <Step title="Work Phase">
    Worker operates autonomously, communicating via relay.
  </Step>
  <Step title="Release">
    Lead releases worker or worker exits naturally.
  </Step>
</Steps>

## CLI Commands

Manage workers from the command line:

```bash
# List all agents including workers
agent-relay agents

# View worker logs
agent-relay agents:logs WorkerName

# Kill a specific worker
agent-relay agents:kill WorkerName
```

## Dashboard API

The dashboard provides REST endpoints for spawning:

### Spawn via API

```bash
curl -X POST http://localhost:3888/api/spawn \
  -H "Content-Type: application/json" \
  -d '{
    "name": "TestWorker",
    "cli": "claude",
    "task": "Write unit tests for the auth module"
  }'
```

### Release via API

```bash
curl -X POST http://localhost:3888/api/release \
  -H "Content-Type: application/json" \
  -d '{
    "name": "TestWorker"
  }'
```

## Agent Limits

Worker counts are limited based on your plan:

| Plan | Max Agents |
|------|------------|
| Free | 3 |
| Pro | 10 |
| Team | 25 |
| Enterprise | Unlimited |

The spawner returns an error when the limit is reached:

```
Agent limit reached (10/10). Upgrade your plan for more agents.
```

## Policy Enforcement

When `AGENT_POLICY_ENFORCEMENT=1` is set, spawning follows policy rules:

```json
{
  "policies": {
    "Lead": {
      "canSpawn": ["Worker*", "Reviewer"],
      "maxWorkers": 5
    }
  }
}
```

Policy violations return a clear error:

```
Policy denied: Lead cannot spawn agent with name AdminBot
```

## Best Practices

<CardGroup cols={2}>
  <Card title="Use Descriptive Names" icon="tag">
    Name workers by their role: `FrontendDev`, `TestWriter`, `Reviewer`.
  </Card>
  <Card title="Sequential Spawning" icon="list-ol">
    Spawn one agent at a time and wait for confirmation before the next.
  </Card>
  <Card title="Release When Done" icon="circle-check">
    Release workers after task completion to free resources.
  </Card>
  <Card title="Define Profiles" icon="id-card">
    Use `.claude/agents/` profiles for consistent agent configurations.
  </Card>
</CardGroup>

## Troubleshooting

<AccordionGroup>
  <Accordion title="Worker fails to register">
    The spawner waits up to 30 seconds for registration. Check:
    1. CLI tool is installed and authenticated
    2. No errors in worker logs: `agent-relay agents:logs WorkerName`
    3. Daemon is running: `agent-relay status`
  </Accordion>
  <Accordion title="Task not delivered to worker">
    Tasks are sent after registration completes. If the task is missing:
    1. Verify dashboard port is set correctly
    2. Check worker logs for errors
    3. Send the task manually via messaging
  </Accordion>
  <Accordion title="Workers crash immediately">
    Common causes:
    1. CLI not authenticated (run `claude` or `codex` manually first)
    2. Missing permissions (check `--dangerously-skip-permissions`)
    3. Resource constraints (memory/CPU limits)
  </Accordion>
</AccordionGroup>
