# Tasks - January 16, 2026

## Summary

This session focused on **relay messaging reliability** and designing a **synchronous request-response protocol** for multi-agent coordination.

### Key Outcomes

1. **Documented why Rust PTY beats tmux send-keys** - Direct syscalls, no shell escaping, 3x faster
2. **Verified PR #197 implemented reliability improvements** - Escalating retry, unread indicators
3. **Designed sync protocol for turn-based coordination** - Solves Hearts game delayed message problem
4. **Added agent-controlled blocking syntax** - `[await]` opt-in, fire-and-forget default

---

## Tasks Ready to Start

### Phase 1: Protocol Foundation (P1)

Start here - no dependencies:

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-483** | Add sync fields to protocol | Add `sync { correlationId, timeoutMs, blocking }` to SendMeta, add `correlationId, response, responseData` to AckPayload |

**Files to modify:**
- `src/protocol/types.ts`

**Acceptance criteria:**
- [ ] `SendMeta.sync` interface defined
- [ ] `AckPayload` extended with correlation fields
- [ ] Types exported from protocol module

---

### Phase 2: Daemon Implementation (P1)

Depends on: agent-relay-483

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-484** | Pending ACK tracking | Track blocking SEND requests by correlationId, resolve when ACK received, handle timeouts |

**Files to modify:**
- `src/daemon/server.ts` - Add `pendingAcks` Map, timeout handling
- `src/daemon/connection.ts` - Wire up ACK correlation in `handleAck()`

**Acceptance criteria:**
- [ ] `pendingAcks: Map<string, PendingAck>` in server
- [ ] Blocking SEND creates pending entry
- [ ] ACK with matching correlationId resolves promise
- [ ] Timeout rejects promise after `timeoutMs`
- [ ] Unit tests for correlation logic

---

### Phase 3: Client API (P1)

Depends on: agent-relay-484

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-485** | Add sendAndWait() | `sendAndWait(to, body, options)` returns `Promise<AckPayload>` |
| **agent-relay-486** | Auto-ACK on correlationId | When incoming message has correlationId, auto-send ACK |

**Files to modify:**
- `src/wrapper/client.ts` - Add `sendAndWait()`, `broadcastAndWait()`
- `src/wrapper/base-wrapper.ts` - Auto-ACK in `handleIncomingMessage()`

**Acceptance criteria:**
- [ ] `sendAndWait()` blocks until ACK or timeout
- [ ] `broadcastAndWait()` waits for all recipients
- [ ] Auto-ACK sent when `meta.sync.correlationId` present
- [ ] Integration tests for end-to-end flow

---

### Phase 4: Agent Syntax (P2)

Depends on: agent-relay-483

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-492** | Parse [await] syntax | Parse `->relay:Target [await] msg` and `->relay:Target [await:30s] msg` |

**Files to modify:**
- `src/wrapper/parser.ts` - Extend inline pattern to capture `[await]` and optional timeout

**Acceptance criteria:**
- [ ] `[await]` captured in ParsedCommand
- [ ] `[await:30s]` parsed as 30000ms timeout
- [ ] Backwards compatible - no `[await]` = fire-and-forget
- [ ] Unit tests for new syntax

---

### Phase 5: Documentation (P2)

Depends on: agent-relay-492

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-493** | Update agent-relay-snippet | Document `[await]` syntax, examples, when to use |

**Files to modify:**
- `docs/agent-relay-snippet.md`

**Acceptance criteria:**
- [ ] Fire-and-forget vs blocking explained
- [ ] `[await]` and `[await:Ns]` syntax documented
- [ ] `[awaiting]` receiver tag documented
- [ ] Usage examples for each pattern

---

## Dependency Graph

```
agent-relay-483 (protocol)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                    â”‚
       â–¼                    â–¼
agent-relay-484 (daemon)   agent-relay-492 (parser)
       â”‚                    â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
       â”‚         â”‚          â”‚
       â–¼         â–¼          â–¼
agent-relay-485  486       agent-relay-493 (docs)
(sendAndWait)  (auto-ACK)
```

---

## Reference Documentation

- `docs/SYNC_MESSAGING_PROTOCOL.md` - Full protocol design
- `docs/RELAY_PTY_IMPROVEMENTS.md` - Reliability background
- `src/protocol/types.ts` - Existing protocol types

---

## Closed Today

| Bead | Task | Reason |
|------|------|--------|
| agent-relay-480 | Escalating retry | Implemented in PR #197 |
| agent-relay-481 | Unread indicator | Implemented in PR #197 |
| agent-relay-482 | Remove formatIncomingMessage | Implemented in PR #197 |

---

## Commands

```bash
# Start work on first task
bd update agent-relay-483 --status=in_progress

# Check what's ready (no blockers)
bd ready

# View task details
bd show agent-relay-483

# Mark complete
bd close agent-relay-483

# Sync when done
bd sync
```

---

## Session 2: Relay-PTY & Continuity Improvements

This session focused on **cloud deployment**, **workspace namespacing**, **file-based continuity**, and **stuck detection**.

### Key Outcomes

1. **Cloud deployment** - Deploy Rust relay-pty to cloud workspaces (P0)
2. **Workspace-namespaced paths** - Socket/outbox paths use workspace ID for multi-tenant isolation
3. **Removed [[SUMMARY]] and [[SESSION_END]]** - Replaced with file-based continuity protocol
4. **Streamlined docs** - Reduced agent-relay-snippet from 247â†’85 lines, protocol from 239â†’102 lines
5. **Stuck detection design** - Simple heuristics in orchestrator, no sidecar needed

---

## ðŸš¨ TOP PRIORITY: Cloud Deployment (P0)

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-504** | Deploy Rust relay-pty to cloud | Add binary to Docker image, install to /usr/local/bin |
| **agent-relay-505** | WORKSPACE_ID env var propagation | Pass workspace ID through stack for namespaced paths |

### agent-relay-504: Deploy Rust relay-pty to cloud

**Files to modify:**
- `deploy/workspace/Dockerfile.base` - Add Rust toolchain or copy pre-built binary
- `deploy/workspace/Dockerfile` - Ensure binary at /usr/local/bin/relay-pty

**Build Strategy Options:**

**Option A: Build in Docker (simpler, slower builds)**
```dockerfile
# In Dockerfile.base
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:$PATH"
COPY relay-pty/ /tmp/relay-pty/
RUN cd /tmp/relay-pty && cargo build --release
RUN cp /tmp/relay-pty/target/release/relay-pty /usr/local/bin/
```

**Option B: Multi-stage Docker build in Dockerfile.base (RECOMMENDED)**
```dockerfile
# deploy/workspace/Dockerfile.base

# Build stage - Rust compilation
FROM rust:1.75-slim AS rust-builder
COPY relay-pty/ /app/
WORKDIR /app
RUN cargo build --release

# Final stage - base image with CLIs + relay-pty binary
FROM node:20-slim
COPY --from=rust-builder /app/target/release/relay-pty /usr/local/bin/
# ... rest of CLI tools setup
```

**Also update CI trigger** (`.github/workflows/docker.yml`):
```yaml
# Rebuild base when relay-pty/ changes
if: |
  github.event.inputs.build_base == 'true' ||
  contains(github.event.head_commit.modified, 'deploy/workspace/Dockerfile.base') ||
  contains(github.event.head_commit.modified, 'relay-pty/')
```

**Decision: Option B in Dockerfile.base + CI trigger update**
- Clean final image (no 500MB+ Rust toolchain)
- relay-pty is infrastructure (changes rarely, like CLI tools)
- 95% of builds skip Rust compilation entirely
- Auto-rebuilds base when relay-pty/ changes

**Acceptance criteria:**
- [ ] Cloud workspace has `/usr/local/bin/relay-pty` binary
- [ ] Binary is executable and correct architecture (Linux x86_64)
- [ ] Orchestrator auto-detects and uses Rust binary
- [ ] File-based messaging works on cloud

### agent-relay-505: WORKSPACE_ID env var propagation

**Problem:** Orchestrator constructs paths like `/tmp/relay-pty-{name}.sock` but doesn't namespace by workspace.

**Solution:** When `WORKSPACE_ID` is set, use namespaced paths:
- Socket: `/tmp/relay/{WORKSPACE_ID}/sockets/{name}.sock`
- Outbox: `/tmp/relay/{WORKSPACE_ID}/outbox/{name}/`

**Files to modify:**
- `src/wrapper/relay-pty-orchestrator.ts` - Use WORKSPACE_ID in path construction
- `src/bridge/spawner.ts` - Ensure WORKSPACE_ID passed to orchestrator env

**Acceptance criteria:**
- [ ] Orchestrator reads WORKSPACE_ID from env
- [ ] Paths namespaced when WORKSPACE_ID set
- [ ] Fallback to current paths when not set (local dev)
- [ ] Spawner passes WORKSPACE_ID to child process env

---

## Workspace Namespacing (P2)

Changes `/tmp/relay-pty-{name}.sock` â†’ `/tmp/relay/{workspaceId}/sockets/{name}.sock`

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-490** | Rust workspace paths | Update Rust binary to use WORKSPACE_ID env var |
| **agent-relay-488** | Socket path namespacing | Change orchestrator socket path |
| **agent-relay-489** | Outbox path namespacing | Change orchestrator outbox path |
| **agent-relay-494** | Update docs | Update agent-relay-snippet with new paths |
| **agent-relay-491** | Workspace cleanup | Clean /tmp/relay/{id}/ on workspace deletion |

**Dependency graph:**
```
agent-relay-490 (Rust)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                  â–¼
agent-relay-488        agent-relay-489
(sockets)              (outbox)
       â”‚                  â”‚
       â–¼                  â–¼
agent-relay-491        agent-relay-494
(cleanup)              (docs)
```

---

## File-Based Continuity (P1-P3)

Replaces `->continuity:save <<<...>>>` terminal pattern with file-based approach.

| Bead | Task | Priority | Description |
|------|------|----------|-------------|
| **agent-relay-497** | Rust continuity support | P1 | Parse `KIND: continuity` files, emit JSON to stderr |
| **agent-relay-498** | Orchestrator continuity | P1 | Handle continuity JSON, call ContinuityManager |
| **agent-relay-499** | Auto-fallback | P2 | Generate fallback continuity on process exit |
| **agent-relay-500** | Remove old parsing | P3 | Remove [[SUMMARY]]/[[SESSION_END]] code |

**Dependency graph:**
```
agent-relay-497 (Rust)
       â”‚
       â–¼
agent-relay-498 (Orchestrator)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                  â–¼
agent-relay-499        agent-relay-500
(auto-fallback)        (cleanup old code)
```

---

## Stuck Detection (P2-P4)

Simple heuristics replace complex sidecar proposal.

| Bead | Task | Priority | Description |
|------|------|----------|-------------|
| **agent-relay-501** | Stuck detection | P2 | Add heuristics: idle 10min, error loop, output loop |
| **agent-relay-502** | Dashboard indicator | P2 | Show STUCK/IDLE badges on agent cards |
| **agent-relay-503** | Webhook notifications | P4 | Optional webhook for stuck/crash events |

**Dependency graph:**
```
agent-relay-501 (detection)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                  â–¼
agent-relay-502        agent-relay-503
(dashboard)            (webhook - backlog)
```

---

## NPM Package & CI (P1-P2)

Tasks for CI integration and package optimization.

| Bead | Task | Priority | Description |
|------|------|----------|-------------|
| **agent-relay-506** | Add Rust tests to CI | P1 | Add `cargo test` to test.yml workflow |
| **agent-relay-507** | Improve Rust test coverage | P2 | Increase from 30 to ~50 tests |
| **agent-relay-508** | On-demand binary download | P2 (v2) | Reduce npm package from 5.4MB to ~200KB |

### agent-relay-506: Add Rust tests to CI

**Files to modify:**
- `.github/workflows/test.yml` - Add Rust toolchain and `cargo test`

**Acceptance criteria:**
- [ ] Rust toolchain installed in CI
- [ ] `cargo test` runs for relay-pty
- [ ] Cargo dependencies cached for speed

### agent-relay-507: Improve Rust test coverage

**Current coverage:**
- parser.rs: 21 tests âœ…
- protocol.rs: 3 tests âœ…
- queue.rs: 3 tests âœ…
- inject.rs: 1 test âš ï¸
- socket.rs: 1 test âš ï¸
- pty.rs: 1 test âš ï¸

**Target:** Add tests for inject formatting, PTY lifecycle, socket error handling

### agent-relay-508: On-demand binary download (v2)

**Current state:** 5.4MB npm package with 3 bundled binaries

**Proposed:**
1. Store binaries in GitHub releases
2. Postinstall downloads correct platform binary
3. Cache downloaded binary
4. Fallback to tmux if download fails

**Target:** ~200KB npm package

---

## Closed This Session

| Bead | Task | Reason |
|------|------|--------|
| agent-relay-495 | Rust detect [[SUMMARY]]/[[SESSION_END]] | Replaced with file-based continuity |
| agent-relay-496 | JSON schemas for summary/session_end | No longer needed |

---

## Recommended Start Order

**Unblocked tasks (start here):**

1. **agent-relay-504** - ðŸš¨ Deploy Rust relay-pty to cloud (P0 - TOP PRIORITY)
2. **agent-relay-505** - ðŸš¨ WORKSPACE_ID env propagation (P1 - required for namespacing)
3. **agent-relay-490** - Rust workspace paths (enables all namespacing work)
4. **agent-relay-497** - Rust continuity support (enables continuity flow)
5. **agent-relay-501** - Stuck detection (enables dashboard/webhook)

**Dependency chain for cloud:**
```
agent-relay-504 (binary in Docker)
       â”‚
       â–¼
agent-relay-505 (WORKSPACE_ID propagation)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                  â–¼
agent-relay-488        agent-relay-489
(socket paths)         (outbox paths)
```

```bash
# START HERE - Cloud deployment (P0)
bd update agent-relay-504 --status=in_progress

# Then WORKSPACE_ID propagation
bd update agent-relay-505 --status=in_progress

# Then namespacing tasks in parallel
bd update agent-relay-488 --status=in_progress
bd update agent-relay-489 --status=in_progress

# Or Rust continuity
bd update agent-relay-497 --status=in_progress

# Or stuck detection
bd update agent-relay-501 --status=in_progress
```

---

## Session 3: Cursor Scaling Analysis

This session analyzed Cursor's scaling agents blog and created proposals for agent-relay.

### Key Outcomes

1. **Synthesized Cursor's scaling journey** - Hierarchical pipeline, optimistic concurrency, prompts > architecture
2. **Audited existing features** - We already have StatelessLead, Consensus, Continuity, ScalingOrchestrator
3. **Identified real gaps** - Role prompts (2-3 days), model selection hookup (0.5 day), documentation (1 day)
4. **Created test-driven approach** - Validate need for advanced features before building

**Reference Documentation:**
- `docs/proposals/cursor-scaling-agents-analysis.md` - Full analysis (982 lines)
- `docs/proposals/cursor-analysis-existing-features-audit.md` - Existing features (422 lines)
- `docs/proposals/cursor-bottom-line-gaps.md` - Real gaps vs theory (348 lines)

---

## ðŸš¨ P0: Quick Wins (2.5-3.5 days)

Start here - highest impact, lowest complexity:

### agent-relay-510: Model selection hookup (P0)

**Priority:** P0 (Blocking for cost optimization)
**Effort:** 0.5 day (5 hours)
**Depends on:** None

**Description:**
Wire up existing `model:` field from agent profiles to spawner. Protocol already has field, profiles already have frontmatter - just need parsing logic.

**Files to modify:**
- `src/bridge/spawner.ts` - Read `model:` from profile frontmatter
- `src/utils/model-mapping.ts` - NEW - Map model to CLI command variant
- `.claude/agents/*.md` - Update 18 profiles with model defaults

**Acceptance criteria:**
- [ ] Spawner reads `model:` from profile frontmatter
- [ ] Model maps to CLI variant (`claude:sonnet`, `claude:opus`, `codex`)
- [ ] Fallback to `claude:sonnet` if not specified
- [ ] All 18 agent profiles have `model:` field
- [ ] Cost tracking in spawner logs (which model used)

**Example:**
```yaml
---
name: Lead
role: planner
model: claude-sonnet-4
canSpawnChildren: true
---
```

Maps to: `claude:sonnet` command

---

### agent-relay-511: Documentation sprint (P0)

**Priority:** P0 (Unlock existing value)
**Effort:** 1 day (8 hours)
**Depends on:** None

**Description:**
Document existing features that are functional but undiscoverable: StatelessLeadCoordinator, Consensus, Continuity.

**Files to modify:**
- `docs/INTEGRATION-GUIDE.md` - Add 3 new sections
- `docs/agent-relay-protocol.md` - Document `->continuity:` patterns
- `docs/EXAMPLES.md` - NEW - Practical examples

**Acceptance criteria:**
- [ ] INTEGRATION-GUIDE.md covers StatelessLeadCoordinator usage
- [ ] Consensus section with `->relay:_consensus` examples
- [ ] Continuity section with `->continuity:save/load/search` examples
- [ ] EXAMPLES.md with 3 end-to-end scenarios:
  - [ ] Hierarchical planning (Lead spawns workers)
  - [ ] Consensus code review (2+ agents approve)
  - [ ] Long-running task with continuity

---

### agent-relay-512: Role-specific prompts (P0)

**Priority:** P0 (Biggest impact per Cursor)
**Effort:** 2-3 days (16-24 hours)
**Depends on:** None (can work in parallel with 510/511)

**Description:**
Build prompt module system with role-specific strategies. Cursor found "a surprising amount of behavior comes down to how we prompt the agents."

**Phase 1: Prompt structure (4 hours)**
- Create `.claude/prompts/roles/` directory
- Write `planner-strategy.md` (how planners decompose tasks)
- Write `worker-focus.md` (keep workers on-task, avoid scope creep)
- Write `reviewer-criteria.md` (what reviewers check)

**Phase 2: Prompt composer (4 hours)**
- Create `src/wrapper/prompt-composer.ts`
- Build `composeForAgent(profile, context)`
- Integrate with `RelayPtyOrchestrator`

**Phase 3: Testing (8-12 hours)**
- Spawn hierarchical team with role prompts
- Measure coordination improvement (qualitative)
- Refine prompts based on observed behavior
- A/B test: prompts vs. no prompts

**Files to modify:**
- `.claude/prompts/roles/planner-strategy.md` - NEW
- `.claude/prompts/roles/worker-focus.md` - NEW
- `.claude/prompts/roles/reviewer-criteria.md` - NEW
- `src/wrapper/prompt-composer.ts` - NEW
- `src/wrapper/relay-pty-orchestrator.ts` - Integrate composer
- `docs/agent-relay-protocol.md` - Document prompt system

**Acceptance criteria:**
- [ ] 3 role prompts written with clear principles
- [ ] PromptComposer dynamically injects based on role
- [ ] Spawner passes role to orchestrator
- [ ] Testing shows improved coordination
- [ ] Documentation explains when to use each role

**Example planner prompt principles:**
- Break down, don't build up (smallest possible tasks)
- Parallelize aggressively (independent tasks run concurrently)
- Avoid doing work yourself (your job is planning, not execution)
- Spawn sub-planners for complex areas

**Example worker prompt principles:**
- Grind on task until done (don't switch contexts)
- Stay focused (ignore tempting refactors outside scope)
- Trust your planner (they decomposed for a reason)
- When stuck, ask for help (don't spin)

---

## ðŸ§ª P1: Validation Testing (1 day)

Test before building proposals 2 & 3:

### agent-relay-513: Scale testing (P1)

**Priority:** P1 (Validate assumptions)
**Effort:** 0.5 day (4 hours)
**Depends on:** agent-relay-510, agent-relay-512

**Description:**
Test if we have coordination bottlenecks that require optimistic concurrency. Cursor saw "20 agents â†’ 2-3 effective throughput" - do we?

**Test plan:**
1. Spawn 20 concurrent agents with coordination tasks
2. Measure message latency (avg, p50, p99)
3. Check for lock contention in daemon logs
4. Monitor CPU/memory usage
5. Measure effective throughput

**Acceptance criteria:**
- [ ] 20+ agents spawned successfully
- [ ] Message latency measured (<100ms target)
- [ ] Lock contention analysis (file-based state access)
- [ ] Test report documenting results
- [ ] GO/NO-GO decision on agent-relay-515 (optimistic concurrency)

**Files to create:**
- `tests/scale/spawn-20-agents.ts` - Scale test script
- `docs/testing/SCALE_TEST_RESULTS.md` - Report

---

### agent-relay-514: Drift testing (P1)

**Priority:** P1 (Validate assumptions)
**Effort:** 0.5 day (4 hours)
**Depends on:** agent-relay-510, agent-relay-512

**Description:**
Test if long-running agents degrade over time, requiring automatic fresh starts. Cursor uses periodic restarts - do we need them?

**Test plan:**
1. Spawn 3 agents with 2+ hour tasks
2. Capture output quality metrics every 15 minutes
3. Check for repetitive patterns (drift detector heuristics)
4. Monitor context window usage
5. Compare quality: 0-30min vs 90-120min

**Acceptance criteria:**
- [ ] 3 agents run for 2+ hours each
- [ ] Output quality tracked over time
- [ ] Repetitive pattern analysis
- [ ] Context usage estimated
- [ ] Test report documenting results
- [ ] GO/NO-GO decision on agent-relay-516 (auto fresh starts)

**Files to create:**
- `tests/drift/long-running-agents.ts` - Drift test script
- `docs/testing/DRIFT_TEST_RESULTS.md` - Report

---

## ðŸ”¬ P2: Advanced Features (Conditional on Testing)

Only implement if agent-relay-513/514 show need:

### agent-relay-515: Optimistic concurrency (P2)

**Priority:** P2 (Only if agent-relay-513 shows bottleneck)
**Effort:** 1 week (40 hours)
**Depends on:** agent-relay-513 (GO decision)

**Description:**
Replace file-based state with versioned state store using optimistic concurrency control. Only implement if scale testing shows lock contention.

**Phase 1: Protocol (8 hours)**
- Add STATE_READ, STATE_WRITE, STATE_CONFLICT messages
- StateWritePayload with expectedVersion
- StateConflictPayload with version info

**Phase 2: Versioned store (16 hours)**
- Create `src/storage/versioned-state.ts`
- Implement read/write with version checking
- Redis adapter for cloud deployment
- Migration from file-based state

**Phase 3: Agent patterns (16 hours)**
- Wrapper helper methods
- Read-modify-write with retry
- Exponential backoff
- Integration tests

**Files to modify:**
- `src/protocol/types.ts` - New message types
- `src/storage/versioned-state.ts` - NEW
- `src/daemon/server.ts` - State operations
- `src/wrapper/base-wrapper.ts` - Client helpers
- `docs/PROTOCOL.md` - Document STATE_* messages

**Acceptance criteria:**
- [ ] Protocol messages defined
- [ ] VersionedStateStore with conflict detection
- [ ] Redis adapter for cloud
- [ ] Client retry patterns
- [ ] Scale test shows improvement (20 agents = 20 effective)

---

### agent-relay-516: Automatic fresh starts (P2)

**Priority:** P2 (Only if agent-relay-514 shows drift)
**Effort:** 2 days (16 hours)
**Depends on:** agent-relay-514 (GO decision)

**Description:**
Add drift detection and automatic restart with continuity handoff. Only implement if drift testing shows degradation.

**Phase 1: Drift detector (4 hours)**
- Create `src/wrapper/drift-detector.ts`
- Repetitive pattern detection
- Context usage estimation
- Configurable thresholds

**Phase 2: Auto-restart (8 hours)**
- Graceful restart logic in BaseWrapper
- Continuity handoff before restart
- Spawn fresh instance with same name
- Config options (maxContextUsagePercent, maxSessionDurationMs)

**Phase 3: Testing (4 hours)**
- Long-running agent tests
- Restart quality validation
- False positive rate

**Files to modify:**
- `src/wrapper/drift-detector.ts` - NEW
- `src/wrapper/base-wrapper.ts` - Auto-restart logic
- `src/continuity/manager.ts` - Graceful handoff
- `docs/agent-relay-protocol.md` - Document auto-restart

**Acceptance criteria:**
- [ ] Drift detector with 3 heuristics (repetition, context, time)
- [ ] Auto-restart with continuity handoff
- [ ] Configurable thresholds
- [ ] Tests show improved long-running quality
- [ ] False positive rate <5%

---

## âœ… P3: Formalize Existing Features (Low Priority)

Nice-to-have formalizations:

### agent-relay-517: Hierarchical roles in protocol (P3)

**Priority:** P3 (Formalization, not new feature)
**Effort:** 1-2 days (8-16 hours)
**Depends on:** agent-relay-510, agent-relay-512

**Description:**
Add role fields to protocol to formalize existing StatelessLeadCoordinator patterns. Low priority because it works without protocol changes.

**Files to modify:**
- `src/protocol/types.ts` - Add `role`, `parentAgent`, `canSpawnChildren` to HelloPayload
- `src/daemon/server.ts` - Validate spawn permissions based on role
- `.claude/agents/*.md` - Add `role:` to all profiles
- `src/dashboard/` - Hierarchy visualization

**Acceptance criteria:**
- [ ] HelloPayload has role fields
- [ ] Daemon enforces canSpawnChildren
- [ ] All 18 profiles have role
- [ ] Dashboard shows hierarchy tree view

---

## Dependency Graph: Cursor Tasks

```
P0 Quick Wins (parallel):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  agent-relay-510 (model selection)      â”‚
â”‚  agent-relay-511 (documentation)        â”‚
â”‚  agent-relay-512 (role prompts)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         P1 Validation Testing:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  agent-relay-513 (scale test)           â”‚
â”‚  agent-relay-514 (drift test)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚           â”‚
         GO? â”€â”˜           â””â”€ GO?
              â”‚               â”‚
              â–¼               â–¼
    agent-relay-515     agent-relay-516
    (optimistic)        (fresh starts)
```

---

## Combined Commands

```bash
# Session 1: Sync messaging protocol
bd update agent-relay-483 --status=in_progress  # Protocol fields
bd update agent-relay-484 --status=in_progress  # Daemon tracking
bd update agent-relay-485 --status=in_progress  # sendAndWait()

# Session 2: Cloud deployment (P0)
bd update agent-relay-504 --status=in_progress  # Rust binary in Docker
bd update agent-relay-505 --status=in_progress  # WORKSPACE_ID propagation
bd update agent-relay-488 --status=in_progress  # Socket namespacing
bd update agent-relay-489 --status=in_progress  # Outbox namespacing

# Session 3: Cursor analysis - P0 quick wins
bd update agent-relay-510 --status=in_progress  # Model selection
bd update agent-relay-511 --status=in_progress  # Documentation
bd update agent-relay-512 --status=in_progress  # Role prompts

# Session 3: Cursor analysis - P1 validation
bd update agent-relay-513 --status=in_progress  # Scale test
bd update agent-relay-514 --status=in_progress  # Drift test

# Session 3: Cursor analysis - P2 conditional
# Only if testing shows need:
bd update agent-relay-515 --status=in_progress  # Optimistic concurrency
bd update agent-relay-516 --status=in_progress  # Auto fresh starts
```

---

## Release Planning

**v1.4.0 (Current Focus):**
- Sync messaging protocol (agent-relay-483-493)
- Cloud deployment (agent-relay-504-505)
- Workspace namespacing (agent-relay-488-491)
- File-based continuity (agent-relay-497-500)
- Stuck detection (agent-relay-501-503)
- Rust CI tests (agent-relay-506)
- Rust test coverage (agent-relay-507)

**v2.0.0 (Package Optimization & Cloud):**
- On-demand binary download (agent-relay-508) - Reduce npm package from 5.4MB to ~200KB
- Cloud real-time messaging (agent-relay-509) - WebSocket push instead of 30s heartbeat polling

**v1.5.0+ (Post-1.4.0):**
- Model selection hookup (agent-relay-510)
- Documentation sprint (agent-relay-511)
- Role-specific prompts (agent-relay-512)
- Validation testing (agent-relay-513-514)
- Conditional advanced features (agent-relay-515-517)

---

*Document updated: January 16, 2026*
