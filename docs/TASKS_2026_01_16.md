# Tasks - January 16, 2026

## Summary

This session focused on **relay messaging reliability** and designing a **synchronous request-response protocol** for multi-agent coordination.

### Key Outcomes

1. **Documented why Rust PTY beats tmux send-keys** - Direct syscalls, no shell escaping, 3x faster
2. **Verified PR #197 implemented reliability improvements** - Escalating retry, unread indicators
3. **Designed sync protocol for turn-based coordination** - Solves Hearts game delayed message problem
4. **Added agent-controlled blocking syntax** - `[await]` opt-in, fire-and-forget default

---

## Tasks Ready to Start

### Phase 1: Protocol Foundation (P1)

Start here - no dependencies:

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-483** | Add sync fields to protocol | Add `sync { correlationId, timeoutMs, blocking }` to SendMeta, add `correlationId, response, responseData` to AckPayload |

**Files to modify:**
- `src/protocol/types.ts`

**Acceptance criteria:**
- [ ] `SendMeta.sync` interface defined
- [ ] `AckPayload` extended with correlation fields
- [ ] Types exported from protocol module

---

### Phase 2: Daemon Implementation (P1)

Depends on: agent-relay-483

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-484** | Pending ACK tracking | Track blocking SEND requests by correlationId, resolve when ACK received, handle timeouts |

**Files to modify:**
- `src/daemon/server.ts` - Add `pendingAcks` Map, timeout handling
- `src/daemon/connection.ts` - Wire up ACK correlation in `handleAck()`

**Acceptance criteria:**
- [ ] `pendingAcks: Map<string, PendingAck>` in server
- [ ] Blocking SEND creates pending entry
- [ ] ACK with matching correlationId resolves promise
- [ ] Timeout rejects promise after `timeoutMs`
- [ ] Unit tests for correlation logic

---

### Phase 3: Client API (P1)

Depends on: agent-relay-484

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-485** | Add sendAndWait() | `sendAndWait(to, body, options)` returns `Promise<AckPayload>` |
| **agent-relay-486** | Auto-ACK on correlationId | When incoming message has correlationId, auto-send ACK |

**Files to modify:**
- `src/wrapper/client.ts` - Add `sendAndWait()`, `broadcastAndWait()`
- `src/wrapper/base-wrapper.ts` - Auto-ACK in `handleIncomingMessage()`

**Acceptance criteria:**
- [ ] `sendAndWait()` blocks until ACK or timeout
- [ ] `broadcastAndWait()` waits for all recipients
- [ ] Auto-ACK sent when `meta.sync.correlationId` present
- [ ] Integration tests for end-to-end flow

---

### Phase 4: Agent Syntax (P2)

Depends on: agent-relay-483

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-492** | Parse [await] syntax | Parse `->relay:Target [await] msg` and `->relay:Target [await:30s] msg` |

**Files to modify:**
- `src/wrapper/parser.ts` - Extend inline pattern to capture `[await]` and optional timeout

**Acceptance criteria:**
- [ ] `[await]` captured in ParsedCommand
- [ ] `[await:30s]` parsed as 30000ms timeout
- [ ] Backwards compatible - no `[await]` = fire-and-forget
- [ ] Unit tests for new syntax

---

### Phase 5: Documentation (P2)

Depends on: agent-relay-492

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-493** | Update agent-relay-snippet | Document `[await]` syntax, examples, when to use |

**Files to modify:**
- `docs/agent-relay-snippet.md`

**Acceptance criteria:**
- [ ] Fire-and-forget vs blocking explained
- [ ] `[await]` and `[await:Ns]` syntax documented
- [ ] `[awaiting]` receiver tag documented
- [ ] Usage examples for each pattern

---

## Dependency Graph

```
agent-relay-483 (protocol)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                    â”‚
       â–¼                    â–¼
agent-relay-484 (daemon)   agent-relay-492 (parser)
       â”‚                    â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
       â”‚         â”‚          â”‚
       â–¼         â–¼          â–¼
agent-relay-485  486       agent-relay-493 (docs)
(sendAndWait)  (auto-ACK)
```

---

## Reference Documentation

- `docs/SYNC_MESSAGING_PROTOCOL.md` - Full protocol design
- `docs/RELAY_PTY_IMPROVEMENTS.md` - Reliability background
- `src/protocol/types.ts` - Existing protocol types

---

## Closed Today

| Bead | Task | Reason |
|------|------|--------|
| agent-relay-480 | Escalating retry | Implemented in PR #197 |
| agent-relay-481 | Unread indicator | Implemented in PR #197 |
| agent-relay-482 | Remove formatIncomingMessage | Implemented in PR #197 |

---

## Commands

```bash
# Start work on first task
bd update agent-relay-483 --status=in_progress

# Check what's ready (no blockers)
bd ready

# View task details
bd show agent-relay-483

# Mark complete
bd close agent-relay-483

# Sync when done
bd sync
```

---

## Session 2: Relay-PTY & Continuity Improvements

This session focused on **cloud deployment**, **workspace namespacing**, **file-based continuity**, and **stuck detection**.

### Key Outcomes

1. **Cloud deployment** - Deploy Rust relay-pty to cloud workspaces (P0)
2. **Workspace-namespaced paths** - Socket/outbox paths use workspace ID for multi-tenant isolation
3. **Removed [[SUMMARY]] and [[SESSION_END]]** - Replaced with file-based continuity protocol
4. **Streamlined docs** - Reduced agent-relay-snippet from 247â†’85 lines, protocol from 239â†’102 lines
5. **Stuck detection design** - Simple heuristics in orchestrator, no sidecar needed

---

## ğŸš¨ TOP PRIORITY: Cloud Deployment (P0)

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-504** | Deploy Rust relay-pty to cloud | Add binary to Docker image, install to /usr/local/bin |
| **agent-relay-505** | WORKSPACE_ID env var propagation | Pass workspace ID through stack for namespaced paths |

### agent-relay-504: Deploy Rust relay-pty to cloud

**Files to modify:**
- `deploy/workspace/Dockerfile.base` - Add Rust toolchain or copy pre-built binary
- `deploy/workspace/Dockerfile` - Ensure binary at /usr/local/bin/relay-pty

**Build Strategy Options:**

**Option A: Build in Docker (simpler, slower builds)**
```dockerfile
# In Dockerfile.base
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:$PATH"
COPY relay-pty/ /tmp/relay-pty/
RUN cd /tmp/relay-pty && cargo build --release
RUN cp /tmp/relay-pty/target/release/relay-pty /usr/local/bin/
```

**Option B: Multi-stage Docker build in Dockerfile.base (RECOMMENDED)**
```dockerfile
# deploy/workspace/Dockerfile.base

# Build stage - Rust compilation
FROM rust:1.75-slim AS rust-builder
COPY relay-pty/ /app/
WORKDIR /app
RUN cargo build --release

# Final stage - base image with CLIs + relay-pty binary
FROM node:20-slim
COPY --from=rust-builder /app/target/release/relay-pty /usr/local/bin/
# ... rest of CLI tools setup
```

**Also update CI trigger** (`.github/workflows/docker.yml`):
```yaml
# Rebuild base when relay-pty/ changes
if: |
  github.event.inputs.build_base == 'true' ||
  contains(github.event.head_commit.modified, 'deploy/workspace/Dockerfile.base') ||
  contains(github.event.head_commit.modified, 'relay-pty/')
```

**Decision: Option B in Dockerfile.base + CI trigger update**
- Clean final image (no 500MB+ Rust toolchain)
- relay-pty is infrastructure (changes rarely, like CLI tools)
- 95% of builds skip Rust compilation entirely
- Auto-rebuilds base when relay-pty/ changes

**Acceptance criteria:**
- [ ] Cloud workspace has `/usr/local/bin/relay-pty` binary
- [ ] Binary is executable and correct architecture (Linux x86_64)
- [ ] Orchestrator auto-detects and uses Rust binary
- [ ] File-based messaging works on cloud

### agent-relay-505: WORKSPACE_ID env var propagation

**Problem:** Orchestrator constructs paths like `/tmp/relay-pty-{name}.sock` but doesn't namespace by workspace.

**Solution:** When `WORKSPACE_ID` is set, use namespaced paths:
- Socket: `/tmp/relay/{WORKSPACE_ID}/sockets/{name}.sock`
- Outbox: `/tmp/relay/{WORKSPACE_ID}/outbox/{name}/`

**Files to modify:**
- `src/wrapper/relay-pty-orchestrator.ts` - Use WORKSPACE_ID in path construction
- `src/bridge/spawner.ts` - Ensure WORKSPACE_ID passed to orchestrator env

**Acceptance criteria:**
- [ ] Orchestrator reads WORKSPACE_ID from env
- [ ] Paths namespaced when WORKSPACE_ID set
- [ ] Fallback to current paths when not set (local dev)
- [ ] Spawner passes WORKSPACE_ID to child process env

---

## Workspace Namespacing (P2)

Changes `/tmp/relay-pty-{name}.sock` â†’ `/tmp/relay/{workspaceId}/sockets/{name}.sock`

| Bead | Task | Description |
|------|------|-------------|
| **agent-relay-490** | Rust workspace paths | Update Rust binary to use WORKSPACE_ID env var |
| **agent-relay-488** | Socket path namespacing | Change orchestrator socket path |
| **agent-relay-489** | Outbox path namespacing | Change orchestrator outbox path |
| **agent-relay-494** | Update docs | Update agent-relay-snippet with new paths |
| **agent-relay-491** | Workspace cleanup | Clean /tmp/relay/{id}/ on workspace deletion |

**Dependency graph:**
```
agent-relay-490 (Rust)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                  â–¼
agent-relay-488        agent-relay-489
(sockets)              (outbox)
       â”‚                  â”‚
       â–¼                  â–¼
agent-relay-491        agent-relay-494
(cleanup)              (docs)
```

---

## File-Based Continuity (P1-P3)

Replaces `->continuity:save <<<...>>>` terminal pattern with file-based approach.

| Bead | Task | Priority | Description |
|------|------|----------|-------------|
| **agent-relay-497** | Rust continuity support | P1 | Parse `KIND: continuity` files, emit JSON to stderr |
| **agent-relay-498** | Orchestrator continuity | P1 | Handle continuity JSON, call ContinuityManager |
| **agent-relay-499** | Auto-fallback | P2 | Generate fallback continuity on process exit |
| **agent-relay-500** | Remove old parsing | P3 | Remove [[SUMMARY]]/[[SESSION_END]] code |

**Dependency graph:**
```
agent-relay-497 (Rust)
       â”‚
       â–¼
agent-relay-498 (Orchestrator)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                  â–¼
agent-relay-499        agent-relay-500
(auto-fallback)        (cleanup old code)
```

---

## Stuck Detection (P2-P4)

Simple heuristics replace complex sidecar proposal.

| Bead | Task | Priority | Description |
|------|------|----------|-------------|
| **agent-relay-501** | Stuck detection | P2 | Add heuristics: idle 10min, error loop, output loop |
| **agent-relay-502** | Dashboard indicator | P2 | Show STUCK/IDLE badges on agent cards |
| **agent-relay-503** | Webhook notifications | P4 | Optional webhook for stuck/crash events |

**Dependency graph:**
```
agent-relay-501 (detection)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                  â–¼
agent-relay-502        agent-relay-503
(dashboard)            (webhook - backlog)
```

---

## Closed This Session

| Bead | Task | Reason |
|------|------|--------|
| agent-relay-495 | Rust detect [[SUMMARY]]/[[SESSION_END]] | Replaced with file-based continuity |
| agent-relay-496 | JSON schemas for summary/session_end | No longer needed |

---

## Recommended Start Order

**Unblocked tasks (start here):**

1. **agent-relay-504** - ğŸš¨ Deploy Rust relay-pty to cloud (P0 - TOP PRIORITY)
2. **agent-relay-505** - ğŸš¨ WORKSPACE_ID env propagation (P1 - required for namespacing)
3. **agent-relay-490** - Rust workspace paths (enables all namespacing work)
4. **agent-relay-497** - Rust continuity support (enables continuity flow)
5. **agent-relay-501** - Stuck detection (enables dashboard/webhook)

**Dependency chain for cloud:**
```
agent-relay-504 (binary in Docker)
       â”‚
       â–¼
agent-relay-505 (WORKSPACE_ID propagation)
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                  â–¼
agent-relay-488        agent-relay-489
(socket paths)         (outbox paths)
```

```bash
# START HERE - Cloud deployment (P0)
bd update agent-relay-504 --status=in_progress

# Then WORKSPACE_ID propagation
bd update agent-relay-505 --status=in_progress

# Then namespacing tasks in parallel
bd update agent-relay-488 --status=in_progress
bd update agent-relay-489 --status=in_progress

# Or Rust continuity
bd update agent-relay-497 --status=in_progress

# Or stuck detection
bd update agent-relay-501 --status=in_progress
```
