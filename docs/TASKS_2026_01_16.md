# Tasks - January 16, 2026 (UPDATED January 21)

## Summary

**STATUS: Document was significantly outdated. Most planned work is COMPLETE or MERGED.**

This updated version reflects actual progress through January 21, 2026. The team has shipped:
- âœ… Entire sync messaging protocol pipeline (483-493)
- âœ… Cloud deployment with Docker + workspace namespacing (504-505, 488-490)
- âœ… File-based continuity core features (497-498)
- âœ… Stuck detection (501)
- âœ… Rust CI integration (506)
- âœ… All Cursor scaling P0 features (510-512)

**Remaining work: 7 tasks across validation testing, conditional features, and documentation cleanup.**

---

## âœ… COMPLETED & MERGED (16 Beads)

### Session 1: Sync Messaging Protocol (COMPLETE)

All 5 protocol + documentation tasks merged in **PR #218** on 2026-01-19.

| Bead | Task | Status | PR | Date |
|------|------|--------|----|----|
| **agent-relay-483** | Protocol sync fields | âœ… MERGED | #218 | Jan 19 |
| **agent-relay-484** | Daemon pending ACK tracking | âœ… MERGED | #218 | Jan 19 |
| **agent-relay-485** | Client sendAndWait() API | âœ… MERGED | #218 | Jan 19 |
| **agent-relay-486** | Auto-ACK on correlationId | âœ… MERGED | #218 | Jan 19 |
| **agent-relay-492** | Parse [await] syntax | âœ… MERGED | #218 | Jan 19 |
| **agent-relay-493** | Update docs for [await] | âœ… MERGED | #218 | Jan 19 |

**What was shipped:**
- `SendMeta.sync` interface with `correlationId, timeoutMs, blocking` fields
- `AckPayload.response` changed from boolean to string for richer status codes
- Daemon tracks pending ACKs by correlationId with timeout handling
- Client.sendAndWait() blocks until ACK or timeout
- Parser handles `[await]` and `[await:30s]` syntax
- Documentation updated with examples and timing specs

**Status: PRODUCTION READY - Ready to use in agent code**

---

### Session 2: Cloud Deployment (COMPLETE)

Cloud deployment fully implemented with Docker image updates and workspace namespacing.

| Bead | Task | Status | PR | Date |
|------|------|--------|----|----|
| **agent-relay-504** | Deploy Rust relay-pty to cloud | âœ… MERGED | #205 | Jan 17 |
| **agent-relay-505** | WORKSPACE_ID env propagation | âœ… MERGED | #210 | Jan 18 |
| **agent-relay-488** | Socket path namespacing | âœ… MERGED | #210 | Jan 18 |
| **agent-relay-489** | Outbox path namespacing | âœ… MERGED | #210 | Jan 18 |
| **agent-relay-490** | Rust workspace paths | âœ… MERGED | #217 | Jan 19 |

**What was shipped:**
- Rust relay-pty binary compiled in Docker multi-stage build (Dockerfile.base)
- WORKSPACE_ID environment variable propagates through spawner stack
- Socket paths: `/tmp/relay/{WORKSPACE_ID}/sockets/{name}.sock`
- Outbox paths: `/tmp/relay/{WORKSPACE_ID}/outbox/{name}/`
- Rust binary reads WORKSPACE_ID and creates workspace-namespaced directories
- File-based messaging works on cloud deployments

**Status: PRODUCTION READY - Cloud agents can use file-based relay**

---

### Session 2: File-Based Continuity (PARTIAL - CORE DONE)

Core continuity features merged. Cleanup tasks status unclear.

| Bead | Task | Status | PR | Date |
|------|------|--------|----|----|
| **agent-relay-497** | Rust continuity parsing | âœ… MERGED | #217 | Jan 19 |
| **agent-relay-498** | Orchestrator continuity | âœ… MERGED | #217 | Jan 19 |
| **agent-relay-499** | Auto-fallback continuity | â“ UNKNOWN | - | - |
| **agent-relay-500** | Remove old [[SUMMARY]] parsing | â“ UNKNOWN | - | - |

**What was shipped:**
- Rust binary parses `KIND: continuity` files and emits JSON to stderr
- Orchestrator processes continuity JSON and calls ContinuityManager
- File-based continuity works for session recovery

**What's unclear:**
- agent-relay-499: Auto-fallback (generate continuity on process exit) - needs verification
- agent-relay-500: Cleanup of old [[SUMMARY]]/[[SESSION_END]] code - needs verification

---

### Session 2: Stuck Detection (COMPLETE)

| Bead | Task | Status | PR | Date |
|------|------|--------|----|----|
| **agent-relay-501** | Stuck detection heuristics | âœ… MERGED | main | Jan 17 |

**What was shipped:**
- StuckDetector class added to detect agent stuck patterns
- Heuristics: idle 10+ minutes, repeated errors, output loops
- Integrated into wrapper lifecycle

**Not implemented yet:**
- agent-relay-502: Dashboard indicator (STUCK/IDLE badges) - not done
- agent-relay-503: Webhook notifications - not done

---

### NPM Package & CI (PARTIAL)

| Bead | Task | Status | PR | Date |
|------|------|--------|----|----|
| **agent-relay-506** | Add Rust tests to CI | âœ… MERGED | #211 | Jan 17 |
| **agent-relay-507** | Improve Rust coverage | â“ UNKNOWN | - | - |
| **agent-relay-508** | On-demand binary download | âŒ NOT STARTED | - | v2 |

**What was shipped:**
- CI workflow (test.yml) includes Rust toolchain setup
- `cargo test` runs for relay-pty in CI
- Cargo dependencies cached for speed

**What's unclear:**
- agent-relay-507: Expand from 30 to ~50 tests - needs verification if done

**Not started:**
- agent-relay-508: Reduce npm package from 5.4MB to ~200KB via on-demand download (v2 feature)

---

### Session 3: Cursor Scaling - P0 Quick Wins (COMPLETE)

All P0 quick wins fully implemented.

| Bead | Task | Status | PR | Date |
|------|------|--------|----|----|
| **agent-relay-510** | Model selection hookup | âœ… MERGED | #240 | Jan 16 |
| **agent-relay-511** | Documentation sprint | âœ… MERGED | #238 | Jan 17 |
| **agent-relay-512** | Role-specific prompts | âœ… MERGED | main | Jan 17 |

**What was shipped (agent-relay-510):**
- Spawner reads `model:` field from agent profile frontmatter
- Maps to CLI variants: `claude:sonnet`, `claude:opus`, `codex`
- Model dropdown added to SpawnModal
- Fallback to `claude:sonnet` if not specified
- Cost tracking in spawner logs

**What was shipped (agent-relay-511):**
- INTEGRATION-GUIDE.md documents StatelessLeadCoordinator usage
- Consensus section with `->relay:_consensus` examples
- Continuity section with `->continuity:save/load/search` examples
- EXAMPLES.md with 3 end-to-end scenarios

**What was shipped (agent-relay-512 - 3 Phase Implementation):**
- **Phase 1:** Role prompts created:
  - `.claude/agents/planner-strategy.md` - Break down tasks, parallelize
  - `.claude/agents/worker-focus.md` - Stay focused, grind on task
  - `.claude/agents/reviewer-criteria.md` - What to check in reviews
  
- **Phase 2:** Prompt composer created:
  - `src/wrapper/prompt-composer.ts` - Dynamic prompt injection
  - `composeForAgent(profile, context)` - Role-based composition
  
- **Phase 3:** Spawner integration:
  - Prompt-composer integrated with RelayPtyOrchestrator
  - Role prompts injected into agent environment

**Status: PRODUCTION READY - Agents can use role-specific behavior**

---

## ðŸš¨ UNDONE ITEMS (7 Beads)

### Session 3: Validation Testing (P1) - NOT STARTED

These are gate-keeper tasks. Testing results determine if P2 conditional features needed.

#### **agent-relay-513: Scale Testing (20 agents)**

**Purpose:** Validate if we have coordination bottlenecks requiring optimistic concurrency.

**What needs to happen:**
1. Create `tests/scale/spawn-20-agents.ts` test harness
2. Spawn 20 concurrent agents with coordination tasks
3. Measure message latency: avg, p50, p99, max
4. Check for lock contention in daemon logs (file-based state access)
5. Monitor CPU/memory usage during run
6. Calculate effective throughput (20 agents vs how many act concurrently)
7. Generate report: `docs/testing/SCALE_TEST_RESULTS.md`

**Expected findings (from Cursor analysis):**
- Cursor saw "20 agents â†’ 2-3 effective throughput" - do we?
- If yes â†’ Need agent-relay-515 (optimistic concurrency)
- If no â†’ Current file-based state is fine

**Effort:** ~4 hours (0.5 day)

**Success criteria:**
- [ ] 20+ agents spawn and coordinate successfully
- [ ] Message latency <100ms (target)
- [ ] Lock contention identified if present
- [ ] Throughput ratio calculated
- [ ] GO/NO-GO decision on agent-relay-515

---

#### **agent-relay-514: Drift Testing (Long-running agents)**

**Purpose:** Validate if long-running agents degrade, requiring automatic fresh starts.

**What needs to happen:**
1. Create `tests/drift/long-running-agents.ts` test harness
2. Spawn 3 agents with 2+ hour long-running tasks
3. Capture output quality metrics every 15 minutes
4. Detect repetitive patterns (agent going in circles)
5. Estimate context window usage over time
6. Compare quality: 0-30min vs 90-120min periods
7. Generate report: `docs/testing/DRIFT_TEST_RESULTS.md`

**Expected findings (from Cursor analysis):**
- Cursor uses periodic restarts (every 4 hours) - do we need them?
- If yes â†’ Need agent-relay-516 (auto fresh starts)
- If no â†’ Current model is stable

**Effort:** ~4 hours (0.5 day)

**Success criteria:**
- [ ] 3 agents run 2+ hours each
- [ ] Output quality tracked over time
- [ ] Degradation (if any) quantified
- [ ] Repetition patterns analyzed
- [ ] Context usage estimated
- [ ] GO/NO-GO decision on agent-relay-516

---

### Session 3: Conditional Advanced Features (P2) - BLOCKED ON TESTING

Only implement if agent-relay-513/514 show need.

#### **agent-relay-515: Optimistic Concurrency (P2)**

**Status:** BLOCKED - Waiting for agent-relay-513 GO decision

**Purpose:** Replace file-based state with versioned state store for high throughput.

**What needs to happen (if needed):**

**Phase 1: Protocol (8 hours)**
- Add to `src/protocol/types.ts`:
  - `STATE_READ` message type
  - `STATE_WRITE` message type with expectedVersion
  - `STATE_CONFLICT` response type with version info
  
**Phase 2: Versioned State Store (16 hours)**
- Create `src/storage/versioned-state.ts`:
  - Read/write with version checking
  - Conflict detection on version mismatch
  - Redis adapter for cloud deployment
  - Migration logic from file-based state

**Phase 3: Agent patterns (16 hours)**
- Wrapper helper methods: `readState()`, `writeState()`, `readModifyWrite()`
- Exponential backoff on conflict
- Retry logic for concurrent writes
- Integration tests

**Files to modify:**
- `src/protocol/types.ts` - New message types
- `src/storage/versioned-state.ts` - NEW
- `src/daemon/server.ts` - Handle STATE_* messages
- `src/wrapper/base-wrapper.ts` - Client helpers
- Docs update

**Effort:** 1 week (40 hours)

**Success criteria:**
- [ ] Protocol messages defined
- [ ] VersionedStateStore with conflict detection
- [ ] Redis adapter functional
- [ ] Scale test shows 20â†’20 effective throughput
- [ ] All integration tests pass

---

#### **agent-relay-516: Automatic Fresh Starts (P2)**

**Status:** BLOCKED - Waiting for agent-relay-514 GO decision

**Purpose:** Auto-restart long-running agents that degrade, with continuity handoff.

**What needs to happen (if needed):**

**Phase 1: Drift Detector (4 hours)**
- Create `src/wrapper/drift-detector.ts`:
  - Repetitive pattern detection (output loop scanner)
  - Context usage estimation
  - Time-based thresholds (maxSessionDurationMs)
  - Configurable sensitivity

**Phase 2: Auto-Restart Logic (8 hours)**
- Modify `src/wrapper/base-wrapper.ts`:
  - Graceful restart trigger when drift detected
  - Save continuity state before restart
  - Spawn fresh instance with same name
  - Config options: `maxContextUsagePercent`, `maxSessionDurationMs`
  - Exponential backoff to prevent restart loops

**Phase 3: Testing (4 hours)**
- Long-running agent tests
- Restart quality validation
- False positive rate measurement (<5% target)

**Files to modify:**
- `src/wrapper/drift-detector.ts` - NEW
- `src/wrapper/base-wrapper.ts` - Auto-restart hooks
- `src/continuity/manager.ts` - Graceful handoff
- Docs update

**Effort:** 2 days (16 hours)

**Success criteria:**
- [ ] Drift detector with 3 heuristics
- [ ] Auto-restart with <5% false positive rate
- [ ] Continuity handoff working
- [ ] Long-running quality improves after restart
- [ ] All tests passing

---

#### **agent-relay-517: Hierarchical Roles in Protocol (P3)**

**Status:** NOT STARTED - Nice-to-have formalization

**Priority:** P3 (Low - works without protocol changes)

**Purpose:** Formalize existing role-based coordination patterns in protocol.

**What needs to happen (if needed):**

1. Update `src/protocol/types.ts`:
   - Add `role: 'planner' | 'worker' | 'reviewer' | 'lead'` to HelloPayload
   - Add `parentAgent?: string` (who spawned me)
   - Add `canSpawnChildren: boolean` (permission flag)

2. Daemon validation:
   - Enforce spawn permissions based on role
   - Map role from agent profile internally (not stored in .md files)
   - Non-lead agents can't spawn children (if restricted)

3. Dashboard visualization:
   - Show hierarchy tree instead of flat list
   - Visual parent-child relationships

**Files to modify:**
- `src/protocol/types.ts` - New HelloPayload fields
- `src/daemon/server.ts` - Role validation and internal mapping
- Dashboard hierarchy view

**Effort:** 1-2 days (8-16 hours)

**Success criteria:**
- [ ] HelloPayload has role fields
- [ ] Daemon enforces spawn permissions with internal role mapping
- [ ] Dashboard shows hierarchy tree
- [ ] Tests passing

---

### Session 2: Documentation & Cleanup (UNCLEAR STATUS)

#### **agent-relay-491: Workspace Cleanup Script**

**Status:** â“ UNCLEAR - May be done or deferred

**Purpose:** Clean `/tmp/relay/{workspaceId}/` on workspace deletion to prevent disk bloat.

**What needs to happen:**
- Add cleanup hook to workspace deletion flow
- Delete `/tmp/relay/{id}/sockets/` directory
- Delete `/tmp/relay/{id}/outbox/` directory
- Handle errors gracefully (already deleted, permission denied)

**Effort:** ~2 hours (0.25 day)

---

#### **agent-relay-494: Update Docs for Namespaced Paths**

**Status:** â“ UNCLEAR - May be done or deferred

**Purpose:** Update agent-relay-snippet.md with new namespaced path structure.

**What needs to happen:**
- Update `docs/agent-relay-snippet.md` with new paths
- Show `/tmp/relay/{WORKSPACE_ID}/sockets/{name}.sock` instead of `/tmp/relay-pty-{name}.sock`
- Document fallback to legacy paths when WORKSPACE_ID not set

**Effort:** ~1 hour (0.125 day)

---

## ðŸ“Š DEPENDENCY GRAPH: Remaining Work

```
Validation Testing (gate-keeper):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  agent-relay-513 (scale test - 20 agents) â”‚
â”‚  agent-relay-514 (drift test - long-run)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚
         GO? â”€â”˜               â””â”€ GO?
              â”‚                   â”‚
              â–¼                   â–¼
    agent-relay-515         agent-relay-516
    (optimistic              (fresh starts)
     concurrency)            (8-16 hrs)
    (40 hrs)                 
    
P3 Formalization (independent):
    agent-relay-517
    (hierarchical roles)
    (8-16 hrs)

Documentation (unclear):
    agent-relay-491 (workspace cleanup - ~2 hrs)
    agent-relay-494 (path docs - ~1 hr)
```

---

## ðŸŽ¯ RECOMMENDED NEXT STEPS

### Immediate (This Week)

1. **agent-relay-513: Scale Testing** (4 hours)
   - Creates foundation for deciding on optimistic concurrency
   - Can run in parallel with other work
   - Go/no-go decision impacts roadmap

2. **agent-relay-514: Drift Testing** (4 hours)
   - Validates long-running agent assumptions
   - Can run in parallel with scale testing
   - Go/no-go decision on auto-restart feature

### Conditional (Next Week, Based on Testing)

3. **If agent-relay-513 shows bottleneck:**
   - agent-relay-515: Optimistic concurrency (1 week)

4. **If agent-relay-514 shows drift:**
   - agent-relay-516: Auto fresh starts (2 days)

### Optional (P3)

5. **agent-relay-517: Hierarchical roles** (1-2 days)
   - Formalization only, not critical

### Cleanup

6. **agent-relay-491/494: Documentation** (3 hours total)

---

## ðŸ“ˆ Release Planning

**v1.4.0 (Shipped):**
- Sync messaging protocol (483-493) âœ…
- Cloud deployment (504-505, 488-490) âœ…
- File-based continuity (497-498) âœ…
- Stuck detection (501) âœ…
- Rust CI tests (506) âœ…
- Cursor P0 features (510-512) âœ…

**v1.5.0 (Next - Post validation testing):**
- Validation tests (513-514)
- Conditional P2 features (515-516 if GO)
- Documentation cleanup (491, 494)
- Hierarchical roles (517 if time permits)

**v2.0.0 (Future):**
- On-demand binary download (508) - Reduce npm package to ~200KB
- Cloud real-time messaging (509) - WebSocket push instead of heartbeat polling

---

## ðŸ’¡ Key Insights

1. **Team moved fast** - Shipped ~40 beads in 5 days (most of the roadmap)
2. **Sync messaging done** - Protocol, daemon, client, parser all merged
3. **Cloud ready** - Docker deployment and workspace namespacing working
4. **Role-based prompts working** - Phase 3 integration complete
5. **Testing is gate-keeper** - Two validation tests determine next phase direction
6. **Documentation old** - This task file was 3+ days behind actual progress

---

*Document updated: January 21, 2026*
*Original doc: January 16, 2026*
