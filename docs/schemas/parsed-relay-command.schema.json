{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://agentrelay.dev/schemas/parsed-relay-command.schema.json",
  "title": "Parsed Relay Command",
  "description": "JSON format emitted by relay-pty to stderr when it detects a relay command (->relay-file:ID pattern)",
  "type": "object",
  "properties": {
    "type": {
      "type": "string",
      "const": "relay_command",
      "description": "Always 'relay_command' to identify this as a parsed relay message"
    },
    "kind": {
      "type": "string",
      "enum": ["message", "spawn", "release"],
      "description": "Command type"
    },
    "from": {
      "type": "string",
      "description": "Sender agent name (from AGENT_RELAY_NAME environment variable)"
    },
    "to": {
      "type": "string",
      "description": "Target agent name, '*' for broadcast, '#channel' for channel, or 'spawn'/'release' for those commands"
    },
    "body": {
      "type": "string",
      "description": "Message body or task description"
    },
    "raw": {
      "type": "string",
      "description": "Original raw text that was parsed (e.g., '->relay-file:msg-001')"
    },
    "thread": {
      "type": "string",
      "description": "Thread identifier for grouping related messages (optional)"
    },
    "spawn_name": {
      "type": "string",
      "description": "For spawn commands: name of the agent to spawn"
    },
    "spawn_cli": {
      "type": "string",
      "description": "For spawn commands: CLI to use (claude, codex, gemini, etc.)"
    },
    "spawn_task": {
      "type": "string",
      "description": "For spawn commands: task description for the spawned agent"
    },
    "release_name": {
      "type": "string",
      "description": "For release commands: name of the agent to release"
    }
  },
  "required": ["type", "kind", "from", "to", "body", "raw"],
  "allOf": [
    {
      "if": {
        "properties": { "kind": { "const": "spawn" } }
      },
      "then": {
        "required": ["spawn_name", "spawn_cli"]
      }
    },
    {
      "if": {
        "properties": { "kind": { "const": "release" } }
      },
      "then": {
        "required": ["release_name"]
      }
    }
  ],
  "examples": [
    {
      "_comment": "Simple message",
      "type": "relay_command",
      "kind": "message",
      "from": "Alice",
      "to": "Bob",
      "body": "Hello Bob, can you review PR #42?",
      "raw": "->relay-file:msg-001"
    },
    {
      "_comment": "Message with thread",
      "type": "relay_command",
      "kind": "message",
      "from": "Alice",
      "to": "Bob",
      "body": "Hello Bob, can you review PR #42?",
      "thread": "feature-123",
      "raw": "->relay-file:msg-002"
    },
    {
      "_comment": "Broadcast message",
      "type": "relay_command",
      "kind": "message",
      "from": "Alice",
      "to": "*",
      "body": "Attention everyone: deployment starting in 5 minutes",
      "raw": "->relay-file:msg-003"
    },
    {
      "_comment": "Channel message",
      "type": "relay_command",
      "kind": "message",
      "from": "Alice",
      "to": "#general",
      "body": "Has anyone seen the new API docs?",
      "raw": "->relay-file:msg-004"
    },
    {
      "_comment": "Spawn command",
      "type": "relay_command",
      "kind": "spawn",
      "from": "Alice",
      "to": "spawn",
      "body": "You are a code reviewer.\nReview the changes in src/auth/*.ts",
      "raw": "->relay-file:spawn-001",
      "spawn_name": "ReviewerAgent",
      "spawn_cli": "claude",
      "spawn_task": "You are a code reviewer.\nReview the changes in src/auth/*.ts"
    },
    {
      "_comment": "Release command",
      "type": "relay_command",
      "kind": "release",
      "from": "Alice",
      "to": "release",
      "body": "",
      "raw": "->relay-file:release-001",
      "release_name": "ReviewerAgent"
    }
  ]
}
